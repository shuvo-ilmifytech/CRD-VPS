name: Windows CRD (Final Curl Fix)

on: workflow_dispatch

jobs:
  build:
    name: Start Windows CRD
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Download CRD (Curl Method)
      run: |
        # Google এর ব্লকিং এড়াতে আমরা Curl ব্যবহার করছি (এটি আগে কাজ করেছে)
        curl -L -o crd.msi "https://dl.google.com/chrome-remote-desktop/chromeremotedesktop.msi"

    - name: Install CRD
      run: |
        Write-Host "Installing CRD..."
        Start-Process msiexec.exe -ArgumentList "/i crd.msi /qn" -Wait
        Remove-Item crd.msi

    - name: Authorize and Start
      shell: powershell
      env:
        # Secret-কে এনভায়রনমেন্ট ভেরিয়েবল হিসেবে নেওয়া হচ্ছে (Syntax Error এড়াতে)
        MY_SECRET_CODE: ${{ secrets.CRD_CODE }}
        MY_PIN: ${{ secrets.PIN }}
      run: |
        # ১. CRD কোথায় ইন্সটল হয়েছে তা চেক করা
        $launcher = "C:\Program Files (x86)\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
        
        if (-not (Test-Path $launcher)) {
            Write-Error "Critical Error: CRD File not found! Installation failed."
            exit 1
        }

        # ২. সিক্রেট কোড থেকে ক্লিন কোড বের করা (Regex দিয়ে)
        # এটি স্পেস বা কোটেশন মার্কের সমস্যা ১০০% দূর করবে
        $rawCode = $env:MY_SECRET_CODE
        if ($rawCode -match '4/[0-9a-zA-Z\-_]+') {
            $cleanCode = $matches[0]
            Write-Host "Code detected successfully."
        } else {
            Write-Error "Invalid Code Format! Make sure you copied the correct code from Google."
            exit 1
        }

        # ৩. মেইন কমান্ড রান করা
        & $launcher --code="$cleanCode" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="GitHub-VPS" --pin="$env:MY_PIN"

    - name: Keep Session Alive
      run: |
        Write-Host "Success! Connect here: https://remotedesktop.google.com/access"
        while ($true) {
          Start-Sleep -Seconds 60
          Write-Host "Session is active..."
        }
